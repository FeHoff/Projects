%% based on: mcinet/mcinet_pipeline_region_growing.m %%

clear all

path_niak = ('/gs/project/gsf-624-aa/quarantaine/niak-issue100/');
addpath(genpath(path_niak))

path_data = '/home/perrine/scratch/RANN/

%%%%%%%%%%%%%%%%%%%%%
%% Grabbing the results from the NIAK fMRI preprocessing pipeline
path_data = '/home/perrine/scratch/RANN/FINAL_preprocess_test_issue100_16.03.03';
%%%%%%%%%%%%%%%%%%%%%
opt_g.min_nb_vol = 50;     % The minimum number of volumes for an fMRI dataset to be included. This option is useful when scrubbing is used, and the resulting time series may be too short.
opt_g.min_xcorr_func = 0; % The minimum xcorr score for an fMRI dataset to be included. This metric is a tool for quality control which assess the quality of non-linear coregistration of functional images in stereotaxic space. Manual inspection of the values during QC is necessary to properly set this threshold.
opt_g.min_xcorr_anat = 0; % The minimum xcorr score for an fMRI dataset to be included. This metric is a tool for quality control which assess the quality of non-linear coregistration of the anatomical image in stereotaxic space. Manual inspection of the values during QC is necessary to properly set this threshold.
opt_g.filter.run = {'ant','syn'}
files_in.data = niak_grab_fmri_preprocess([path_data 'FINAL_preprocess_test_issue100_16.03.03/'],opt_g).data; % Replace the folder by the path where the results of the fMRI preprocessing pipeline were stored. 

%opt_g.filter.session = {'session1'};
%opt_g.exclude_subject = {'sub1','sub2'}; % If for whatever reason some subjects have to be excluded that were not caught by the quality control metrics, it is possible to manually specify their IDs here.

%%%%%%%%%%%%%
%% Options %%
%%%%%%%%%%%%%
opt.folder_out = [path_data 'region_growing_16.03.27']; % Where to store the results
%opt.flag_roi = false; % Only generate the ROI parcelation
opt.region_growing.thre_size = 1000; % The critical size for regions

%% Run the pipeline
opt.flag_test = false;
[pipeline_rg,opt] = niak_pipeline_stability_rest(files_in,opt);
